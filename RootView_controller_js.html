<script>
  // Controller definition
  sap.ui.define([
    "jquery.sap.global",
    "sap/ui/core/mvc/Controller",
    "sap/ui/model/Filter",
    "sap/ui/model/json/JSONModel",
    "sap/m/MessageBox",
    "sap/m/MessageToast",
  ], function(jQuery, Controller, Filter, JSONModel, MessageBox, MessageToast) {
    "use strict";

    return Controller.extend("root.Controller", {
      onInit: function(oEvent) {
        // Ensure the loading sequence of all views
        var that = this;
        
        const results = Promise.all([ getRangeData("Store", "A2:A", "", true),
                                      retrieveGrocery("Grocery"),
                                      retrieveGroceryHistory("Grocery History")
        ])
        .then(function(res) {
          //res will be an array

          let oModel = new sap.ui.model.json.JSONModel();
          let oInitData = initData();
          let t = [];

          for (var i = 0; i < res[0].length; i++){
              t.push({ "key" : i,
                       "text": res[0][i]
                    });
          }        

          //oInitData.TopFlexBoxBusy = false;
          oInitData.DDStore = t;
          oInitData.GroceryList = res[1];
          oModel.setData(oInitData);
          that.getView().setModel(oModel);          

          // Finally got it working of using Model name reference
          let oModel_1 = new sap.ui.model.json.JSONModel();
          t = [];
          t = { PastGroceryList: res[2] };
          //t.PastGroceryList.push({
          //  "Store":      "S1",
          //  "Ingredient": "I1",
          //  "Recipe":     "R1"
          //})
          oModel_1.setData(t);
          that.getView().byId("iDtblHistoryGroceryList").setModel(oModel_1, "PGL");          

          that.getView().getModel().setProperty("/TopFlexBoxBusy", false);

        }).catch(function(msg) {
          console.log(msg);
        });
      },

      onStoreComboChange: function(oEvent) {
        const oView = this.getView();
        oView.getModel().setProperty("/TopFlexBoxBusy", true);

        let keyStore = oView.byId("idDDStore").getSelectedKey();
        let keyItem  = oView.byId("idDDStore").getSelectedItem();
        const lStore = keyItem.getBindingContext().getObject().text;

        getIngridentsPerStore(lStore).then((res) => {
          oView.byId("idDDIngre").clearSelection();

          let t   = [];
          for (var i = 0; i < res.length; i++){
              t.push({ "key" : i,
                       "text": res[i]
                    });
          }
          oView.getModel().setProperty("/DDIngre", t);
          oView.getModel().setProperty("/TopFlexBoxBusy", false);
        })  
      },

      onBtnAdd: function(oEvent) {
        const oView = this.getView();
        var   enteredingredient = oView.byId("idDDIngre").getValue();
        const keyStore  = oView.byId("idDDStore").getSelectedKey(),
              storeText = oView.byId("idDDStore").getSelectedItem().getText(),
              keyIngre  = oView.byId("idDDIngre").getSelectedKey();

        if ( keyStore === "" || keyStore === " " ) {
          sap.m.MessageToast.show("Please select a store!");
          return;
        }
        if ( enteredingredient === "" ) {
          sap.m.MessageToast.show("Please enter or select an ingredient!");
          return;
        }
        //if ( keyIngre === "" || keyIngre === " " ) { 
        //}

        // check if entered ingredient exists
        const len     = oView.byId("idDDIngre").getItems().length;
        let   bExists = false;
        for (let i=0;i<len;i++) {
          const itemText = oView.byId("idDDIngre").getItems()[i].getProperty("text");              
          if (itemText === enteredingredient) {
            bExists = true;
            break;
          }
        }

        if (!bExists) {
          // ingredient doesn't exist in the database
          const sTitle="Confirmation";
          MessageBox.show( "'" + enteredingredient + "' doesn't exist in the database. Would you like to add it?", {
            icon: MessageBox.Icon.QUESTION,
            title: sTitle ,
            actions: [MessageBox.Action.YES, MessageBox.Action.NO],
            emphasizedAction: MessageBox.Action.NO,
            onClose: function (oAction) {
              if (oAction === 'YES') {
                const oGlobalBusyDialog = new sap.m.BusyDialog({text: "Adding " + enteredingredient + " to database..."});
                oGlobalBusyDialog.open();

                insertIngredientToDatabase(storeText, enteredingredient).then(function(res) {
                  if (res.length > 0) {
                    const t = oView.getModel().getProperty("/DDIngre");
                    if ( t.length === 0 ) {
                      t = [];
                    }
                    console.log(t);
                    t.push({ "key" : t.length + 1,
                             "text": enteredingredient
                          });
                    oView.getModel().setProperty("/DDIngre", t);
                  }
                  oGlobalBusyDialog.close();
                })
              }
            }
          });
        }
        else {
          enteredingredient = oView.byId("idDDIngre").getSelectedItem().getBindingContext().getObject().text;
        }


        oView.getModel().setProperty("/TopFlexBoxBusy", true);
        
        let arrayGrocery = [];
        const sStore = oView.byId("idDDStore").getSelectedItem().getBindingContext().getObject().text;
        const sIngre = enteredingredient;
        arrayGrocery.push(sStore);
        arrayGrocery.push(sIngre);
        arrayGrocery.push("");
        appendGroceryToSheet("Grocery", arrayGrocery).then((res) => {
          const t = oView.getModel().getProperty("/GroceryList");
          oView.getModel().setProperty("/GroceryList", res);
          oView.byId("idDDIngre").clearSelection();
          oView.byId("iDtblGroceryList").removeSelections(true);
          oView.getModel().setProperty("/TopFlexBoxBusy", false);
        })
      },

      // https://plnkr.co/edit/FCrGwsBM4K0E16XFEOEc?p=preview&preview
      onBtnAddBack: function(oEvent) {
        var that = this;
        const sTitle="Confirmation";
        MessageBox.show("Are you sure moving selected grocery back to Grocery?", {
          icon: MessageBox.Icon.QUESTION,
          title: sTitle ,
          actions: [MessageBox.Action.YES, MessageBox.Action.NO],
          emphasizedAction: MessageBox.Action.NO,
          onClose: function (oAction) {
            if (oAction === 'YES') {
              const oTable = that.getView().byId("iDtblHistoryGroceryList");
              const idx = oTable.indexOfItem(oTable.getSelectedItem());
              if (idx !== -1) {
                var arrayRowNo = [];
                const oItems = oTable.getSelectedItems();

                for (let i=0 ; i<oItems.length ; i++) {
                  arrayRowNo.push(oItems[i].getBindingContext("PGL").getObject().rowNo);
                }
                const oGlobalBusyDialog = new sap.m.BusyDialog({text: "Moving selected grocery back to Grocery..."});
                oGlobalBusyDialog.open();

                moveHistoryToGrocery("Grocery History", arrayRowNo, "Grocery").then(function(res) {
                  const results = Promise.all([ 
                                                retrieveGrocery("Grocery"),
                                                retrieveGroceryHistory("Grocery History")
                  ])
                  .then(function(res) {     
                    that.getView().getModel().setProperty("/GroceryList", res[0]);
                    that.getView().byId("iDtblHistoryGroceryList").getModel("PGL").setProperty("/PastGroceryList", res[1]);

                    oView.byId("iDtblHistoryGroceryList").removeSelections(true);
                    oView.byId("panelHistory").setExpanded(false);
                    oGlobalBusyDialog.close();

                  }).catch(function(msg) {
                    console.log(msg);
                  });
                })      
              }

            }
          }
        });
      },

      onGroceryItemEdit: function(oEvent) {
        // learned from https://plnkr.co/edit/qifky6plPEzFtlpyV2vb?p=preview&preview
        console.log("onGroceryItemEdit event triggered!!!")
      },

      onSelectedGrocery: function(oEvent) {
          // learned from https://plnkr.co/edit/mNxnG4CnxmzjkCGKkDEw?p=preview&preview
          const oSelectedItem = oEvent.getParameter("listItem");
          const oModel = oSelectedItem.getBindingContext().getObject();
          var that = this;
          //that.getView().getModel().setProperty("/TopFlexBoxBusy", true);
          const oGlobalBusyDialog = new sap.m.BusyDialog({text: "Moving selected grocery to History..."});
          oGlobalBusyDialog.open();

          moveGroceryToHistory("Grocery", oModel.rowNo, "Grocery History", 2).then(function(res) {
            const results = Promise.all([ 
                                          retrieveGrocery("Grocery"),
                                          retrieveGroceryHistory("Grocery History")
            ])
            .then(function(res) {     
              that.getView().getModel().setProperty("/GroceryList", res[0]);
              that.getView().byId("iDtblHistoryGroceryList").getModel("PGL").setProperty("/PastGroceryList", res[1]);

              //that.getView().getModel().setProperty("/TopFlexBoxBusy", false);
              oGlobalBusyDialog.close();

            }).catch(function(msg) {
              console.log(msg);
            });

          })
      }
    });
  });
</script>

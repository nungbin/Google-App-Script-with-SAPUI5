<script>
  // Controller definition
  sap.ui.define([
    'jquery.sap.global',
    'sap/ui/core/mvc/Controller',
    'sap/ui/model/Filter',
    'sap/ui/model/json/JSONModel'
  ], function(jQuery, Controller, Filter, JSONModel) {
    "use strict";

    return Controller.extend("root.Controller", {
      onInit: function(oEvent) {
        // Ensure the loading sequence of all views
        var that = this;
        
        const results = Promise.all([ getRangeData("Store", "A2:A", "", true),
                                      retrieveGrocery("Grocery"),
                                      retrieveGroceryHistory("Grocery History")
        ])
        .then(function(res) {
          //res will be an array

          let oModel = new sap.ui.model.json.JSONModel();
          let oInitData = initData();
          let t = [];

          for (var i = 0; i < res[0].length; i++){
              t.push({ "key" : i,
                       "text": res[0][i]
                    });
          }        

          //oInitData.TopFlexBoxBusy = false;
          oInitData.DDStore = t;
          oInitData.GroceryList = res[1];
          oModel.setData(oInitData);
          that.getView().setModel(oModel);          

          // Finally got it working of using Model name reference
          let oModel_1 = new sap.ui.model.json.JSONModel();
          t = [];
          t = { PastGroceryList: res[2] };
          //t.PastGroceryList.push({
          //  "Store":      "S1",
          //  "Ingredient": "I1",
          //  "Recipe":     "R1"
          //})
          oModel_1.setData(t);
          that.getView().byId("iDtblPastGroceryList").setModel(oModel_1, "PGL");          

          that.getView().getModel().setProperty("/TopFlexBoxBusy", false);

        }).catch(function(msg) {
          console.log(msg);
        });
      },

      onStoreComboChange: function(oEvent) {
        const oView = this.getView();
        oView.getModel().setProperty("/TopFlexBoxBusy", true);

        let keyStore = oView.byId("idDDStore").getSelectedKey();
        let keyItem  = oView.byId("idDDStore").getSelectedItem();
        const lStore = keyItem.getBindingContext().getObject().text;

        //console.log(keyItem.getBindingContext().getObject().key);
        //console.log(keyItem.getBindingContext().getObject().text);
        getIngridentsPerStore(lStore).then((res) => {
          oView.byId("idDDIngre").clearSelection();

          let t   = [];
          for (var i = 0; i < res.length; i++){
              t.push({ "key" : i,
                      "text": res[i]
                    });
          }
          oView.getModel().setProperty("/DDIngre", t);
          oView.getModel().setProperty("/TopFlexBoxBusy", false);
        })  
      },

      onBtnAdd: function(oEvent) {
        const oView = this.getView();
        let keyStore = oView.byId("idDDStore").getSelectedKey(),
            keyIngre = oView.byId("idDDIngre").getSelectedKey()

        if ( keyStore === "" || keyStore === " " ) {
          sap.m.MessageToast.show("Please select a store!");
          return;
        }
        if ( keyIngre === "" || keyIngre === " " ) {
          sap.m.MessageToast.show("Please select an ingredient!");
          return;
        }

        oView.getModel().setProperty("/TopFlexBoxBusy", true);
        
        let arrayGrocery = [];
        const sStore = oView.byId("idDDStore").getSelectedItem().getBindingContext().getObject().text;
        const sIngre = oView.byId("idDDIngre").getSelectedItem().getBindingContext().getObject().text;
        arrayGrocery.push(sStore);
        arrayGrocery.push(sIngre);
        arrayGrocery.push("");
        appendGroceryToSheet("Grocery", arrayGrocery).then((res) => {
          const t = oView.getModel().getProperty("/GroceryList");
          oView.getModel().setProperty("/GroceryList", res);
          oView.byId("idDDIngre").clearSelection();
          oView.getModel().setProperty("/TopFlexBoxBusy", false);
        })
      },

      onGroceryItemEdit: function(oEvent) {
        // learned from https://plnkr.co/edit/qifky6plPEzFtlpyV2vb?p=preview&preview
        console.log("onGroceryItemEdit event triggered!!!")
      },

      onSelectedGrocery: function(oEvent) {
          // learned from https://plnkr.co/edit/mNxnG4CnxmzjkCGKkDEw?p=preview&preview
          const oSelectedItem = oEvent.getParameter("listItem");
          const oModel = oSelectedItem.getBindingContext().getObject();
          var that = this;
          that.getView().getModel().setProperty("/TopFlexBoxBusy", true);

          console.log(oModel);
          moveGroceryToHistory("Grocery", oModel.rowNo, "Grocery History", 2).then(function(res) {

            const results = Promise.all([ 
                                          retrieveGrocery("Grocery"),
                                          retrieveGroceryHistory("Grocery History")
            ])
            .then(function(res) {
              console.log(res);      
              that.getView().getModel().setProperty("/GroceryList", res[0]);
              that.getView().byId("iDtblPastGroceryList").getModel("PGL").setProperty("/PastGroceryList", res[1]);

              that.getView().getModel().setProperty("/TopFlexBoxBusy", false);

            }).catch(function(msg) {
              console.log(msg);
            });

          })
      }
    });
  });
</script>

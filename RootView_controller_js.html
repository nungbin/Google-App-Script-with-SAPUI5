<script>
  function rootViewInit(pView) {
      let oModel = new sap.ui.model.json.JSONModel();
      let oInitData = initData();
      oModel.setData(oInitData);
      pView.setModel(oModel);
      // sap.ui.getCore().setModel(oModel);

      getRangeData("Store", "A2:A", "", true).then((res) => {
        let t = [];

        for (var i = 0; i < res.length; i++){
            t.push({ "key" : i,
                     "text": res[i]
                   });
        }

        oInitData.DDStore = t;
        oModel.setData(oInitData);
        pView.setModel(oModel);
      })


      // Finally got it working of using Model name reference
      let oModel_1 = new sap.ui.model.json.JSONModel();
      let t = { PastGroceryList: [] };
      t.PastGroceryList.push({
        "Store":      "S1",
        "Ingredient": "I1",
        "Recipe":     "R1"
      })
      oModel_1.setData(t);
      pView.byId("iDtblPastGroceryList").setModel(oModel_1, "PGL");
      //console.log(pView.byId("iDtblPastGroceryList"));
  }

  
  function root_btnAdd() {
    let oView    = window.rootView;
    let keyStore = oView.byId("idDDStore").getSelectedKey(),
        keyIngre = oView.byId("idDDIngre").getSelectedKey()

    console.log(keyStore);
    if ( keyStore === "" || keyStore === " " ) {
      sap.m.MessageToast.show("Please select a store!");
      return;
    }
    if ( keyIngre === "" || keyIngre === " " ) {
      sap.m.MessageToast.show("Please select an ingredient!");
      return;
    }

    let tt  = oView.getModel();
    let ttt = tt.getData();
    let t = ttt.GroceryList;
    const sStore = oView.byId("idDDStore").getSelectedItem().getBindingContext().getObject().text;
    const sIngre = oView.byId("idDDIngre").getSelectedItem().getBindingContext().getObject().text;
    console.log(sStore + ":" + sIngre);
    t.push({ "chkGrocery"  : false,
             "Store"       : sStore,
             "Ingredient"  : sIngre,
             "Recipe"      : ""
          });

    // don't understand why setting data/model has to be this convoluted!!!
    ttt.GroceryList = t;
    tt.setData(ttt);
    oView.setModel(tt);
  }


  function root_storeComboChange() {
    let oView    = window.rootView;

    oView.byId("idDDStore").setEnabled(false);
    oView.byId("idDDStore").setBusy(true);
    oView.byId("idDDIngre").setEnabled(false);
    oView.byId("idDDIngre").setBusy(true);

    let keyStore = oView.byId("idDDStore").getSelectedKey();
    let keyItem  = oView.byId("idDDStore").getSelectedItem();
    const lStore = keyItem.getBindingContext().getObject().text;

    //console.log(keyItem.getBindingContext().getObject().key);
    //console.log(keyItem.getBindingContext().getObject().text);
    getIngridentsPerStore(lStore).then((res) => {
      oView.byId("idDDIngre").clearSelection();

      let t   = [];
      for (var i = 0; i < res.length; i++){
          t.push({ "key" : i,
                   "text": res[i]
                });
      }
      oView.getModel().setProperty("/DDIngre", t);

      oView.byId("idDDStore").setEnabled(true);
      oView.byId("idDDStore").setBusy(false);
      oView.byId("idDDIngre").setEnabled(true);
      oView.byId("idDDIngre").setBusy(false);
    })
  }
</script>

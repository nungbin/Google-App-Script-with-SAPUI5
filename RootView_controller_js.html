<script>
  // Controller definition
  sap.ui.define([
    'jquery.sap.global',
    'sap/ui/core/mvc/Controller',
    'sap/ui/model/Filter',
    'sap/ui/model/json/JSONModel'
  ], function(jQuery, Controller, Filter, JSONModel) {
    "use strict";

    return Controller.extend("root.Controller", {
      onInit: function(oEvent) {
        // Ensure the loading sequence of all views
        var that = this;
        const results = Promise.all([ getRangeData("Store", "A2:A", "", true),
                                      retrieveGrocery("Result")
        ])
        .then(function(res) {
          //res will be an array
          console.log(res);
          let oModel = new sap.ui.model.json.JSONModel();
          let oInitData = initData();

          let t = [];

          for (var i = 0; i < res[0].length; i++){
              t.push({ "key" : i,
                      "text": res[0][i]
                    });
          }        

          oInitData.TopFlexBoxBusy = false;
          oInitData.DDStore = t;
          oInitData.GroceryList = res[1];
          oModel.setData(oInitData);
          that.getView().setModel(oModel);     
        }).catch(function(msg) {
          console.log(msg);
        });
      },

      storeComboChange: function(oEvent) {
        const oView = this.getView();
        oView.getModel().setProperty("/TopFlexBoxBusy", true);

        let keyStore = oView.byId("idDDStore").getSelectedKey();
        let keyItem  = oView.byId("idDDStore").getSelectedItem();
        const lStore = keyItem.getBindingContext().getObject().text;

        //console.log(keyItem.getBindingContext().getObject().key);
        //console.log(keyItem.getBindingContext().getObject().text);
        getIngridentsPerStore(lStore).then((res) => {
          oView.byId("idDDIngre").clearSelection();

          let t   = [];
          for (var i = 0; i < res.length; i++){
              t.push({ "key" : i,
                      "text": res[i]
                    });
          }
          oView.getModel().setProperty("/DDIngre", t);
          oView.getModel().setProperty("/TopFlexBoxBusy", false);
        })  
      },

      btnAdd: function(oEvent) {
        const oView = this.getView();
        let keyStore = oView.byId("idDDStore").getSelectedKey(),
            keyIngre = oView.byId("idDDIngre").getSelectedKey()

        if ( keyStore === "" || keyStore === " " ) {
          sap.m.MessageToast.show("Please select a store!");
          return;
        }
        if ( keyIngre === "" || keyIngre === " " ) {
          sap.m.MessageToast.show("Please select an ingredient!");
          return;
        }

        oView.getModel().setProperty("/TopFlexBoxBusy", true);
        
        let arrayGrocery = [];
        const sStore = oView.byId("idDDStore").getSelectedItem().getBindingContext().getObject().text;
        const sIngre = oView.byId("idDDIngre").getSelectedItem().getBindingContext().getObject().text;
        arrayGrocery.push(sStore);
        arrayGrocery.push(sIngre);
        arrayGrocery.push("");
        appendGroceryToSheet("Result", arrayGrocery).then((res) => {
          const t = oView.getModel().getProperty("/GroceryList");
          oView.getModel().setProperty("/GroceryList", res);
          oView.getModel().setProperty("/TopFlexBoxBusy", false);
        })
      },

      onSelectionChange: function(oEvent) {

      }
    });
  });
</script>
